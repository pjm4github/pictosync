{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pictosync.io/schemas/annotation_schema.json",
  "title": "PictoSync Annotation Schema",
  "description": "JSON Schema for diagram annotation items used in PictoSync for canvas, property panel, and AI extraction interchange.",
  "type": "object",
  "required": ["annotations"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version identifier",
      "enum": ["draft-1", "overlay-1.0"]
    },
    "image": {
      "$ref": "#/$defs/imageInfo"
    },
    "background_png": {
      "type": "string",
      "description": "Path to the background PNG image"
    },
    "scene_rect": {
      "$ref": "#/$defs/sceneRect"
    },
    "annotations": {
      "type": "array",
      "description": "List of annotation items",
      "items": {
        "$ref": "#/$defs/annotationItem"
      }
    }
  },
  "$defs": {
    "imageInfo": {
      "type": "object",
      "description": "Information about the source image",
      "properties": {
        "width": {
          "type": "number",
          "minimum": 0,
          "description": "Image width in pixels"
        },
        "height": {
          "type": "number",
          "minimum": 0,
          "description": "Image height in pixels"
        },
        "path": {
          "type": "string",
          "description": "Path to the image file"
        }
      }
    },
    "sceneRect": {
      "type": "object",
      "description": "Scene rectangle bounds",
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" },
        "w": { "type": "number", "minimum": 0 },
        "h": { "type": "number", "minimum": 0 }
      }
    },
    "annotationItem": {
      "type": "object",
      "description": "A single annotation item",
      "required": ["kind"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this annotation",
          "pattern": "^[a-zA-Z][a-zA-Z0-9_]*$"
        },
        "kind": {
          "type": "string",
          "enum": ["rect", "roundedrect", "ellipse", "line", "text", "hexagon", "cylinder", "blockarrow", "polygon", "curve", "group"],
          "description": "The type of annotation item"
        },
        "geom": {
          "$ref": "#/$defs/geometry"
        },
        "children": {
          "type": "array",
          "description": "Child annotations for group items",
          "items": {
            "$ref": "#/$defs/annotationItem"
          }
        },
        "meta": {
          "$ref": "#/$defs/annotationMeta"
        },
        "style": {
          "$ref": "#/$defs/styleDefinition"
        },
        "text": {
          "type": "string",
          "description": "Text content: for text items this is the displayed text; for lines this is the relationship label overlaying the line"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "kind": { "const": "rect" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/rectGeometry" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "roundedrect" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/roundedRectGeometry" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "ellipse" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/rectGeometry" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "line" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/lineGeometry" },
              "style": { "$ref": "#/$defs/lineStyleDefinition" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "text" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/pointGeometry" }
            },
            "required": ["text"]
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "hexagon" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/hexagonGeometry" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "cylinder" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/cylinderGeometry" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "blockarrow" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/blockArrowGeometry" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "curve" } }
          },
          "then": {
            "properties": {
              "geom": { "$ref": "#/$defs/curveGeometry" },
              "style": { "$ref": "#/$defs/lineStyleDefinition" }
            }
          }
        },
        {
          "if": {
            "properties": { "kind": { "const": "group" } }
          },
          "then": {
            "required": ["children"],
            "properties": {
              "children": {
                "type": "array",
                "items": { "$ref": "#/$defs/annotationItem" }
              }
            }
          }
        }
      ]
    },
    "geometry": {
      "type": "object",
      "description": "Geometry specification (varies by item kind)",
      "oneOf": [
        { "$ref": "#/$defs/rectGeometry" },
        { "$ref": "#/$defs/roundedRectGeometry" },
        { "$ref": "#/$defs/lineGeometry" },
        { "$ref": "#/$defs/pointGeometry" },
        { "$ref": "#/$defs/hexagonGeometry" },
        { "$ref": "#/$defs/cylinderGeometry" },
        { "$ref": "#/$defs/blockArrowGeometry" },
        { "$ref": "#/$defs/curveGeometry" }
      ]
    },
    "rectGeometry": {
      "type": "object",
      "description": "Rectangle geometry (rect, ellipse)",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {
          "type": "number",
          "description": "X position of top-left corner"
        },
        "y": {
          "type": "number",
          "description": "Y position of top-left corner"
        },
        "w": {
          "type": "number",
          "minimum": 0,
          "description": "Width"
        },
        "h": {
          "type": "number",
          "minimum": 0,
          "description": "Height"
        }
      },
      "additionalProperties": false
    },
    "roundedRectGeometry": {
      "type": "object",
      "description": "Rounded rectangle geometry",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {
          "type": "number",
          "description": "X position of top-left corner"
        },
        "y": {
          "type": "number",
          "description": "Y position of top-left corner"
        },
        "w": {
          "type": "number",
          "minimum": 0,
          "description": "Width"
        },
        "h": {
          "type": "number",
          "minimum": 0,
          "description": "Height"
        },
        "adjust1": {
          "type": "number",
          "minimum": 0,
          "maximum": 200,
          "default": 10,
          "description": "Corner radius in pixels",
          "ui_label": "Radius",
          "ui_suffix": " px"
        }
      },
      "additionalProperties": false
    },
    "lineGeometry": {
      "type": "object",
      "description": "Line geometry with start and end points",
      "required": ["x1", "y1", "x2", "y2"],
      "properties": {
        "x1": {
          "type": "number",
          "description": "Start point X"
        },
        "y1": {
          "type": "number",
          "description": "Start point Y"
        },
        "x2": {
          "type": "number",
          "description": "End point X"
        },
        "y2": {
          "type": "number",
          "description": "End point Y"
        }
      },
      "additionalProperties": false
    },
    "pointGeometry": {
      "type": "object",
      "description": "Point geometry for text placement",
      "required": ["x", "y"],
      "properties": {
        "x": {
          "type": "number",
          "description": "X position"
        },
        "y": {
          "type": "number",
          "description": "Y position"
        }
      },
      "additionalProperties": false
    },
    "hexagonGeometry": {
      "type": "object",
      "description": "Hexagon geometry with adjust1 control (indent ratio)",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {
          "type": "number",
          "description": "X position of top-left corner"
        },
        "y": {
          "type": "number",
          "description": "Y position of top-left corner"
        },
        "w": {
          "type": "number",
          "minimum": 0,
          "description": "Width"
        },
        "h": {
          "type": "number",
          "minimum": 0,
          "description": "Height"
        },
        "adjust1": {
          "type": "number",
          "minimum": 0,
          "maximum": 0.5,
          "default": 0.25,
          "description": "Horizontal indent ratio for top/bottom vertices (0.0-0.5)",
          "ui_label": "Indent",
          "ui_suffix": " %"
        }
      },
      "additionalProperties": false
    },
    "cylinderGeometry": {
      "type": "object",
      "description": "Cylinder geometry with adjust1 control (cap ratio)",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {
          "type": "number",
          "description": "X position of top-left corner"
        },
        "y": {
          "type": "number",
          "description": "Y position of top-left corner"
        },
        "w": {
          "type": "number",
          "minimum": 0,
          "description": "Width"
        },
        "h": {
          "type": "number",
          "minimum": 0,
          "description": "Height"
        },
        "adjust1": {
          "type": "number",
          "minimum": 0.01,
          "maximum": 0.5,
          "default": 0.15,
          "description": "Cap ellipse height as ratio of total height (0.01-0.5)",
          "ui_label": "Cap",
          "ui_suffix": " %"
        }
      },
      "additionalProperties": false
    },
    "blockArrowGeometry": {
      "type": "object",
      "description": "Block arrow geometry with adjust1 (shaft width) and adjust2 (head length) controls",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {
          "type": "number",
          "description": "X position of top-left corner"
        },
        "y": {
          "type": "number",
          "description": "Y position of top-left corner"
        },
        "w": {
          "type": "number",
          "minimum": 0,
          "description": "Width"
        },
        "h": {
          "type": "number",
          "minimum": 0,
          "description": "Height"
        },
        "adjust2": {
          "type": "number",
          "minimum": 10,
          "maximum": 1200,
          "default": 15,
          "description": "Arrow head length in pixels",
          "ui_label": "Head",
          "ui_suffix": " px"
        },
        "adjust1": {
          "type": "number",
          "minimum": 0.01,
          "maximum": 1.0,
          "default": 0.65,
          "description": "Shaft height as ratio of total height (0.0-0.9)",
          "ui_label": "Shaft",
          "ui_suffix": " %"
        }
      },
      "additionalProperties": false
    },
    "curveNode": {
      "type": "object",
      "description": "A single node in a curve path",
      "required": ["cmd"],
      "properties": {
        "cmd": {
          "type": "string",
          "enum": ["M", "L", "H", "V", "C", "S", "Q", "T", "A", "Z"],
          "description": "SVG path command"
        },
        "x": { "type": "number", "description": "Endpoint X (0-1 relative)" },
        "y": { "type": "number", "description": "Endpoint Y (0-1 relative)" },
        "c1x": { "type": "number", "description": "First control point X (cubic)" },
        "c1y": { "type": "number", "description": "First control point Y (cubic)" },
        "c2x": { "type": "number", "description": "Second control point X (cubic)" },
        "c2y": { "type": "number", "description": "Second control point Y (cubic)" },
        "cx": { "type": "number", "description": "Control point X (quadratic)" },
        "cy": { "type": "number", "description": "Control point Y (quadratic)" },
        "rx": { "type": "number", "description": "Arc radius X" },
        "ry": { "type": "number", "description": "Arc radius Y" },
        "rotation": { "type": "number", "description": "Arc rotation in degrees" },
        "large_arc": { "type": "integer", "enum": [0, 1], "description": "Large arc flag" },
        "sweep": { "type": "integer", "enum": [0, 1], "description": "Sweep direction flag" }
      }
    },
    "curveGeometry": {
      "type": "object",
      "description": "Curve geometry with bounding box and path nodes",
      "required": ["x", "y", "w", "h", "nodes"],
      "properties": {
        "x": { "type": "number", "description": "Bounding box X" },
        "y": { "type": "number", "description": "Bounding box Y" },
        "w": { "type": "number", "minimum": 0, "description": "Bounding box width" },
        "h": { "type": "number", "minimum": 0, "description": "Bounding box height" },
        "nodes": {
          "type": "array",
          "description": "Path nodes with SVG-like commands",
          "items": { "$ref": "#/$defs/curveNode" },
          "minItems": 2
        }
      }
    },
    "annotationMeta": {
      "type": "object",
      "description": "Annotation metadata including labels and formatting",
      "properties": {
        "kind": {
          "type": "string",
          "description": "Semantic kind (may differ from item kind, e.g., 'Component', 'Database')"
        },
        "label": {
          "type": "string",
          "default": "",
          "description": "Primary label text"
        },
        "tech": {
          "type": "string",
          "default": "",
          "description": "Technology or protocol (e.g., 'HTTPS/JSON', 'gRPC', 'Kafka')"
        },
        "note": {
          "type": "string",
          "default": "",
          "description": "Freeform note or description"
        },
        "label_align": {
          "type": "string",
          "enum": ["left", "center", "right"],
          "default": "center",
          "description": "Label text alignment"
        },
        "label_size": {
          "type": "integer",
          "minimum": 6,
          "maximum": 72,
          "default": 12,
          "description": "Label font size in points"
        },
        "tech_align": {
          "type": "string",
          "enum": ["left", "center", "right"],
          "default": "center",
          "description": "Tech text alignment"
        },
        "tech_size": {
          "type": "integer",
          "minimum": 6,
          "maximum": 72,
          "default": 10,
          "description": "Tech font size in points"
        },
        "note_align": {
          "type": "string",
          "enum": ["left", "center", "right"],
          "default": "center",
          "description": "Note text alignment"
        },
        "note_size": {
          "type": "integer",
          "minimum": 6,
          "maximum": 72,
          "default": 10,
          "description": "Note font size in points"
        },
        "text_valign": {
          "type": "string",
          "enum": ["top", "middle", "bottom"],
          "default": "top",
          "description": "Vertical alignment of text block within the shape"
        },
        "text_spacing": {
          "type": "number",
          "minimum": 0,
          "maximum": 2,
          "default": 0,
          "description": "Spacing between label/tech/note lines (in em units: 0, 0.5, 1, 1.5, 2)"
        },
        "text_box_width": {
          "type": "number",
          "minimum": 0,
          "default": 0,
          "description": "Text box width for line labels (0 = auto-size)"
        },
        "text_box_height": {
          "type": "number",
          "minimum": 0,
          "default": 0,
          "description": "Text box height for line labels (0 = auto-size)"
        }
      },
      "additionalProperties": true
    },
    "colorHex": {
      "type": "string",
      "pattern": "^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$",
      "description": "Hex color string (#RRGGBB or #RRGGBBAA)"
    },
    "penStyle": {
      "type": "object",
      "description": "Pen/stroke style",
      "properties": {
        "color": {
          "$ref": "#/$defs/colorHex"
        },
        "width": {
          "type": "number",
          "minimum": 0,
          "default": 2,
          "description": "Stroke width in pixels"
        },
        "dash": {
          "type": "string",
          "enum": ["solid", "dashed"],
          "default": "solid",
          "description": "Line dash style"
        },
        "dash_pattern_length": {
          "type": "number",
          "minimum": 4,
          "maximum": 100,
          "default": 30,
          "description": "Total length of dash pattern in pixels (when dash is 'dashed')"
        },
        "dash_solid_percent": {
          "type": "number",
          "minimum": 1,
          "maximum": 99,
          "default": 50,
          "description": "Percentage of pattern that is solid (when dash is 'dashed')"
        }
      }
    },
    "fillStyle": {
      "type": "object",
      "description": "Fill/background style",
      "properties": {
        "color": {
          "$ref": "#/$defs/colorHex"
        }
      }
    },
    "textStyle": {
      "type": "object",
      "description": "Text style",
      "properties": {
        "color": {
          "$ref": "#/$defs/colorHex"
        },
        "size_pt": {
          "type": "number",
          "minimum": 6,
          "maximum": 72,
          "default": 12,
          "description": "Font size in points"
        }
      }
    },
    "styleDefinition": {
      "type": "object",
      "description": "Complete style definition for an item",
      "properties": {
        "pen": {
          "$ref": "#/$defs/penStyle"
        },
        "fill": {
          "$ref": "#/$defs/fillStyle"
        },
        "text": {
          "$ref": "#/$defs/textStyle"
        }
      }
    },
    "lineStyleDefinition": {
      "type": "object",
      "description": "Style definition for line items (includes arrow mode)",
      "properties": {
        "pen": {
          "$ref": "#/$defs/penStyle"
        },
        "fill": {
          "$ref": "#/$defs/fillStyle"
        },
        "text": {
          "$ref": "#/$defs/textStyle"
        },
        "arrow": {
          "type": "string",
          "enum": ["none", "start", "end", "both"],
          "default": "none",
          "description": "Arrowhead mode"
        },
        "arrow_size": {
          "type": "number",
          "minimum": 4,
          "maximum": 50,
          "default": 12,
          "description": "Arrowhead size in pixels"
        }
      }
    }
  }
}
