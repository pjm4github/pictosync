@startuml FIG4_Diagnostic_Session_Sequence
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam defaultFontSize 10
skinparam sequence {
  ArrowColor #555555
  LifeLineBorderColor #888888
  ParticipantBackgroundColor #F0F4FF
  ParticipantBorderColor #8888CC
}

title **FIG. 4 — Anomaly-Triggered Voice-First Diagnostic Session**

participant "OT Process\nBus" as OT #FFDDDD
participant "Anomaly\nDetector" as AD #CCE5FF
participant "Tag\nStore" as TS #E0D0FF
participant "Recommendation\nEngine" as RE #FFE8CC
participant "Policy\nEngine" as PE #E8F0FF
participant "SME\nOperator" as SME #FFE0B0
participant "Voice Intent\nEngine" as VIE #F0FFE0
participant "Ephemeral\nFusion Engine" as EFE #CCE5FF
participant "IT Systems\n(AMI, EAM...)" as IT #CCFFCC
participant "Skill\nRepository" as SR #FFE8CC

== Phase 1: Anomaly Trigger ==

OT -> AD : continuous OT\nstream (IEC 61850,\nDNP3, GOOSE)
activate AD
AD -> AD : classify anomaly\n(type, severity,\nasset fingerprint)
AD -> TS : **pre-scan**(asset, feeder,\nanomaly_type)
activate TS
TS --> AD : prior tagged results\n+ diagnostic chains\n+ relevance scores
deactivate TS
AD -> PE : request qualified\noperator routing
activate PE
PE -> PE : map anomaly domain\n→ required skills\n→ available operators
PE --> AD : qualified operator:\nSME (skill=0.82)
deactivate PE

== Phase 2: Operator Notification ==

AD -> SME : **push notification**\n- anomaly type/severity\n- asset ID & waveform\n- prior tag IDs\n- one-tap to open voice UI
deactivate AD
SME -> PE : authenticate\n(MFA + device cert)
activate PE
PE --> SME : identity verified,\nskills loaded
deactivate PE

== Phase 3: Iterative Skill Recommendation ==

SME -> VIE : (taps mic) **"yes"**
activate VIE
VIE -> VIE : parse intent:\nINITIATE_FUSION
VIE -> RE : request recommendations\n(anomaly context +\nprior tags)
activate RE
RE -> RE : 6-signal scoring:\nanomaly match, asset class,\ntag history, chain pattern,\nSME request, prior chain
RE --> VIE : ranked skills:\n1. harmonic-analysis (0.59)\n2. asset-health (0.47)\n3. load-profile (0.41)
deactivate RE
VIE --> SME : "Recommend:\nharmonic-analysis v2.1"
deactivate VIE

== Phase 4: First Fusion Cycle ==

SME -> VIE : **"fuse it"**
activate VIE
VIE -> VIE : parse intent:\nACCEPT_SKILL
VIE -> SR : pull skill package\n(harmonic-analysis v2.1)
activate SR
SR --> VIE : skill package\n(signed, validated)
deactivate SR
VIE -> EFE : execute fusion\n(skill + anomaly context)
activate EFE
EFE -> EFE : create encrypted\ntmpfs workspace
EFE -> IT : hydrate connectors\n(short-lived tokens)
activate IT
IT --> EFE : IT enrichment data\n→ encrypted tmpfs
deactivate IT
EFE -> EFE : fuse OT + IT data\n→ result: 3rd_harmonic\nTHD 8.2%, confidence 0.94
EFE --> VIE : skill result +\nupdated context
deactivate EFE
VIE --> SME : "Harmonic analysis:\n3rd harmonic THD 8.2%.\nRecommend: asset-health"
deactivate VIE

== Phase 5: Second Fusion Cycle (Iterative) ==

SME -> VIE : **"check the\nmaintenance history"**
activate VIE
VIE -> VIE : parse intent:\nREQUEST_SKILL\nparam="maintenance history"
VIE -> RE : re-rank with new\ncontext (thermal stress)
activate RE
RE --> VIE : asset-health-check\npromoted to top
deactivate RE
VIE -> EFE : execute asset-health\n(reuses workspace)
activate EFE
EFE -> IT : pull maintenance records
activate IT
IT --> EFE : work orders → tmpfs
deactivate IT
EFE -> EFE : fuse → health_score=41\n(declining trend)
EFE --> VIE : result + composite\nconfidence=0.91
deactivate EFE
VIE --> SME : "Health score 41,\ndeclining. Composite\nconfidence 91%."
deactivate VIE

== Phase 6: SME Note + Tag ==

SME -> VIE : **"harmonics correlate\nwith industrial load\non feeder 12"**
activate VIE
VIE -> VIE : parse intent: ADD_NOTE
VIE --> SME : "Note added."
deactivate VIE

SME -> VIE : **"tag it"**
activate VIE
VIE -> VIE : parse intent: TAG_RESULT
VIE -> EFE : finalize + erase
activate EFE

== Phase 7: Erasure + Persistence ==

EFE -> EFE : **ERASE:**\n1. zero RAM pages\n2. destroy AES key\n3. unmount tmpfs\n4. generate attestation
EFE -> TS : **persist tagged result**\n(insight + tags + transcript\n+ attestation + chain links)
activate TS
TS --> EFE : tag-3217 stored
deactivate TS
EFE -> SR : report outcome metrics\n(skill accuracy +Δ)
EFE -> PE : update operator\nskill score (+0.02)
EFE --> VIE : session complete
deactivate EFE
VIE --> SME : "Tagged as tag-3217.\nIT data erased.\nSession complete."
deactivate VIE

@enduml